<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover" />
<title>CÃ¢mera com Moldura Animada</title>

<style>
:root{
  --record:#ff3b3b;
  --ui-bg:rgba(0,0,0,.45);
}

*{box-sizing:border-box;}

body{
  margin:0;
  background:#000;
  color:#fff;
  width:100vw;
  height:100dvh;
  overflow:hidden;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
}

.stage{position:relative;width:100%;height:100%;}

video,canvas{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
  display:none;
}

/* ===== UI ===== */
.ui-layer{
  position:absolute;
  inset:0;
  z-index:20;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  padding:20px;
  pointer-events:none;
}

/* ===== TOP ===== */
.top-bar{
  display:flex;
  justify-content:space-between;
  pointer-events:auto;
}

.icon-btn{
  width:52px;
  height:52px;
  border-radius:50%;
  border:none;
  background:var(--ui-bg);
  color:#fff;
  font-size:24px;
  display:flex;
  align-items:center;
  justify-content:center;
}

.timer{
  background:var(--record);
  padding:6px 14px;
  border-radius:14px;
  font-weight:600;
  display:none;
}

/* ===== CONTROLS ===== */
.controls-bottom{
  display:flex;
  justify-content:center;
  pointer-events:auto;
}

.capture-controls{
  display:flex;
  align-items:center;
  gap:26px;
}

.photo-btn{
  width:66px;
  height:66px;
  border-radius:50%;
  border:3px solid #fff;
  background:rgba(255,255,255,.25);
  font-size:26px;
}

.video-btn{
  width:92px;
  height:92px;
  border-radius:50%;
  border:4px solid #fff;
  background:rgba(255,255,255,.15);
}

.video-btn.recording{
  background:rgba(255,0,0,.45);
  border-color:var(--record);
}

/* ===== RESULT ===== */
#resultUI{
  display:none;
  pointer-events:auto;
}

#resultUI .buttons{
  width:100%;
  display:flex;
  flex-direction:column;
  gap:14px;
  align-items:center;
}

#resultUI button{
  width:90%;
  max-width:340px;
  font-size:20px;
  padding:16px;
  border:none;
  border-radius:40px;
}

#shareBtn{
  background:linear-gradient(135deg,#E1306C,#FD1D1D,#F77737);
  color:#fff;
}

#downloadBtn{background:#fff;color:#000;}
#newPhotoBtn{background:#444;color:#fff;}

/* ===== START ===== */
#startScreen{
  position:absolute;
  inset:0;
  background:url('capajpg.jpg') center/cover;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:50;
}

#startBtn{
  padding:18px 36px;
  font-size:20px;
  border:none;
  border-radius:40px;
  background:#FF5722;
  color:#fff;
}
</style>
</head>

<body>

<div class="stage">

<video id="camera" autoplay playsinline muted></video>
<canvas id="canvasPreview"></canvas>
<canvas id="canvasFinal"></canvas>
<video id="videoPreview" playsinline controls></video>

<div class="ui-layer" id="cameraUI" style="display:none;">
  <div class="top-bar">
    <button id="switchBtn" class="icon-btn">ðŸ”„</button>
    <div id="timer" class="timer">00:00</div>
  </div>

  <div class="controls-bottom">
    <div class="capture-controls">
      <button id="photoBtn" class="photo-btn">ðŸ“·</button>
      <button id="videoBtn" class="video-btn"></button>
    </div>
  </div>
</div>

<div class="ui-layer" id="resultUI">
  <div></div>
  <div class="buttons">
    <button id="shareBtn">ðŸ“¤ Compartilhar</button>
    <button id="downloadBtn">ðŸ“¥ Baixar</button>
    <button id="newPhotoBtn">ðŸ”„ Novo</button>
  </div>
</div>

</div>

<div id="startScreen">
  <button id="startBtn">INICIAR</button>
</div>

<script>
const TOTAL_FRAMES=30, FRAME_INTERVAL=60;
const frames=[];
for(let i=1;i<=TOTAL_FRAMES;i++){
  const img=new Image();
  img.src=`assets/frame_${i}.png`;
  frames.push(img);
}

let stream, usingFront=true;
let raf,isRecording=false,recorder,chunks=[];
let startTime=0,currentDownload=null;
let frameIndex=0,lastFrameTime=0;

const ctxP=canvasPreview.getContext('2d');
const ctxF=canvasFinal.getContext('2d');

function drawVideo(ctx,w,h){
  const vw=camera.videoWidth,vh=camera.videoHeight;
  if(!vw)return;
  const r=Math.max(w/vw,h/vh);
  ctx.drawImage(camera,(w-vw*r)/2,(h-vh*r)/2,vw*r,vh*r);
}

function drawFrame(ctx,w,h,t){
  if(t-lastFrameTime>FRAME_INTERVAL){
    frameIndex=(frameIndex+1)%TOTAL_FRAMES;
    lastFrameTime=t;
  }
  const img=frames[frameIndex];
  if(img.complete)ctx.drawImage(img,0,0,w,h);
}

function previewLoop(t){
  canvasPreview.width=1080;
  canvasPreview.height=1920;
  ctxP.fillStyle="#fff";
  ctxP.fillRect(0,0,1080,1920);
  drawVideo(ctxP,1080,1920);
  drawFrame(ctxP,1080,1920,t);
  raf=requestAnimationFrame(previewLoop);
}

/* ===== FOTO (JPEG sRGB) ===== */
photoBtn.onclick=()=>{
  cancelAnimationFrame(raf);
  canvasFinal.width=1080;
  canvasFinal.height=1920;
  ctxF.fillStyle="#fff";
  ctxF.fillRect(0,0,1080,1920);
  drawVideo(ctxF,1080,1920);
  drawFrame(ctxF,1080,1920,performance.now());

  canvasFinal.toBlob(b=>{
    const url=URL.createObjectURL(b);
    currentDownload={blob:b,url,name:`foto_${Date.now()}.jpg`,mime:'image/jpeg'};
    showResult();
  },'image/jpeg',0.95);
};

/* ===== VIDEO ===== */
videoBtn.onclick=()=>isRecording?stopVideo():startVideo;

function startVideo(){
  isRecording=true;
  videoBtn.classList.add('recording');
  timer.style.display='block';
  startTime=Date.now();
  chunks=[];
  canvasFinal.width=720;
  canvasFinal.height=1280;

  (function loop(t){
    if(!isRecording)return;
    ctxF.clearRect(0,0,720,1280);
    drawVideo(ctxF,720,1280);
    drawFrame(ctxF,720,1280,t);
    timer.innerText=`00:${String(Math.floor((Date.now()-startTime)/1000)).padStart(2,'0')}`;
    requestAnimationFrame(loop);
  })();

  const cs=canvasFinal.captureStream(30);
  stream.getAudioTracks().forEach(tr=>cs.addTrack(tr));
  recorder=new MediaRecorder(cs,{mimeType:'video/webm'});
  recorder.ondataavailable=e=>chunks.push(e.data);
  recorder.onstop=()=>{
    const blob=new Blob(chunks,{type:'video/webm'});
    const url=URL.createObjectURL(blob);
    currentDownload={blob,url,name:`video_${Date.now()}.webm`,mime:'video/webm'};
    videoPreview.src=url;
    videoPreview.style.display='block';
    showResult();
  };
  recorder.start();
}

function stopVideo(){
  isRecording=false;
  videoBtn.classList.remove('recording');
  timer.style.display='none';
  recorder.stop();
}

function showResult(){
  cameraUI.style.display='none';
  resultUI.style.display='flex';
}

downloadBtn.onclick=()=>{
  const a=document.createElement('a');
  a.href=currentDownload.url;
  a.download=currentDownload.name;
  a.click();
};

shareBtn.onclick=async()=>{
  if(!navigator.canShare)return;
  const file=new File([currentDownload.blob],currentDownload.name,{type:currentDownload.mime});
  await navigator.share({files:[file]});
};

newPhotoBtn.onclick=()=>{
  resultUI.style.display='none';
  videoPreview.style.display='none';
  cameraUI.style.display='flex';
  previewLoop(performance.now());
};

switchBtn.onclick=()=>{usingFront=!usingFront;initCamera();};

async function initCamera(){
  stream&&stream.getTracks().forEach(t=>t.stop());
  stream=await navigator.mediaDevices.getUserMedia({
    video:{facingMode:usingFront?'user':'environment'},
    audio:true
  });
  camera.srcObject=stream;
  camera.onloadedmetadata=()=>{
    startScreen.style.display='none';
    cameraUI.style.display='flex';
    camera.style.display='block';
    canvasPreview.style.display='block';
    previewLoop(performance.now());
  };
}

startBtn.onclick=initCamera;
</script>

</body>
</html>
