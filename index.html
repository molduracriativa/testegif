<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Câmera com Moldura Animada PNG</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: #000;
  overflow: hidden;
}

#stage {
  position: relative;
  width: 100vw;
  height: 100vh;
}

video, canvas {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
}

#controls {
  position: absolute;
  bottom: 20px;
  width: 100%;
  display: flex;
  justify-content: center;
  gap: 20px;
  z-index: 10;
}

button {
  padding: 14px 24px;
  border-radius: 30px;
  border: none;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
}
</style>
</head>

<body>

<div id="stage">
  <video id="camera" autoplay muted playsinline></video>
  <canvas id="canvas"></canvas>

  <div id="controls">
    <button id="startRec">Gravar</button>
    <button id="stopRec">Parar</button>
  </div>
</div>

<script>
/* ===== CONFIGURAÇÃO ===== */
const TOTAL_FRAMES = 30;
const FPS = 15;
const FRAME_FOLDER = 'assets/frames';

/* ===== ELEMENTOS ===== */
const video = document.getElementById('camera');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

/* ===== RESOLUÇÃO FINAL DO VÍDEO ===== */
canvas.width = 720;
canvas.height = 1280;

/* ===== CÂMERA ===== */
let cameraStream;
navigator.mediaDevices.getUserMedia({
  video: { facingMode: 'user' },
  audio: true
}).then(stream => {
  cameraStream = stream;
  video.srcObject = stream;
});

/* ===== PRELOAD DOS FRAMES ===== */
const frames = [];
for (let i = 1; i <= TOTAL_FRAMES; i++) {
  const img = new Image();
  img.src = `${FRAME_FOLDER}/frame_${i}.png`;
  frames.push(img);
}

/* ===== LOOP DE RENDER ===== */
let frameIndex = 0;
let lastTime = 0;

function render(timestamp) {
  if (timestamp - lastTime > 1000 / FPS) {
    frameIndex = (frameIndex + 1) % frames.length;
    lastTime = timestamp;
  }

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // câmera
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  // moldura animada
  const frame = frames[frameIndex];
  if (frame.complete) {
    ctx.drawImage(frame, 0, 0, canvas.width, canvas.height);
  }

  requestAnimationFrame(render);
}

requestAnimationFrame(render);

/* ===== GRAVAÇÃO ===== */
let recorder;
let recordedChunks = [];

document.getElementById('startRec').onclick = () => {
  const canvasStream = canvas.captureStream(30);

  cameraStream.getAudioTracks().forEach(track => {
    canvasStream.addTrack(track);
  });

  recorder = new MediaRecorder(canvasStream, {
    mimeType: 'video/webm'
  });

  recordedChunks = [];

  recorder.ondataavailable = e => {
    if (e.data.size > 0) recordedChunks.push(e.data);
  };

  recorder.onstop = () => {
    const blob = new Blob(recordedChunks, { type: 'video/webm' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = 'video_com_moldura.webm';
    a.click();
  };

  recorder.start();
};

document.getElementById('stopRec').onclick = () => {
  if (recorder && recorder.state !== 'inactive') {
    recorder.stop();
  }
};
</script>

</body>
</html>
