<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>CÃ¢mera com Moldura Animada</title>

<style>
:root { --accent:#25D366; --record:#ff0000; }
* { box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
body { margin:0; background:#000; color:#fff; overflow:hidden; width:100vw; height:100dvh; font-family:sans-serif; }

.frame,.stage{position:relative;width:100%;height:100%;overflow:hidden;}
#camera{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;}
#canvasPreview,#videoPreview{position:absolute;inset:0;width:100%;height:100%;display:none;z-index:6;}
#canvasFinal{display:none;}

.ui-layer{
  position:absolute;inset:0;z-index:20;
  display:flex;flex-direction:column;
  justify-content:space-between;padding:20px;
  pointer-events:none;
}

.top-bar{display:flex;justify-content:space-between;pointer-events:auto;}
.timer-badge{background:var(--record);padding:6px 14px;border-radius:14px;display:none;}

.controls-bottom{display:flex;flex-direction:column;align-items:center;gap:30px;pointer-events:auto;}
.capture-controls{display:flex;gap:20px;}

.action-btn-mini,.action-btn-large{
border-radius:50%;border:3px solid #fff;
background:rgba(255,255,255,.2);
display:flex;align-items:center;justify-content:center;
}
.action-btn-mini{width:54px;height:54px;font-size:24px;}
.action-btn-large{width:86px;height:86px;}
.action-btn-large.recording{
border-color:var(--record);
background:rgba(255,0,0,.4);
}

#resultUI{
  display:none;
  justify-content:flex-end;
  align-items:center;
  gap:16px;
  pointer-events:auto;
}

#resultUI button{
  font-size:20px;
  padding:16px 28px;
  border:none;
  border-radius:40px;
  background:#ffffff;
  color:#000;
}

#startScreen{
position:absolute;inset:0;
background:url('capajpg.jpg') center/cover;
display:flex;align-items:center;justify-content:center;
z-index:50;
}
#startBtn{
padding:18px 32px;font-size:20px;
border:none;border-radius:50px;
background:#FF5722;color:#fff;
}

.flash{position:absolute;inset:0;background:#fff;opacity:0;transition:.1s;z-index:10;}
</style>
</head>

<body>

<div class="frame">
<div class="stage">

<video id="camera" autoplay playsinline muted></video>
<canvas id="canvasPreview"></canvas>
<canvas id="canvasFinal"></canvas>
<video id="videoPreview" playsinline controls></video>

<div class="flash" id="flash"></div>

<div class="ui-layer" id="cameraUI" style="display:none;">
  <div class="top-bar">
    <button id="switchBtn">ðŸ”„</button>
    <div id="recordingTimer" class="timer-badge">00:00</div>
  </div>

  <div class="controls-bottom">
    <div class="capture-controls">
      <button id="capturePhotoBtn" class="action-btn-mini">ðŸ“·</button>
      <button id="captureVideoBtn" class="action-btn-large"></button>
    </div>
  </div>
</div>

<div class="ui-layer" id="resultUI">
  <button id="downloadBtn">ðŸ“¥ Baixar</button>
  <button id="newPhotoBtn">ðŸ”„ Novo</button>
</div>

</div>
</div>

<div id="startScreen">
<button id="startBtn">INICIAR</button>
</div>

<script>
/* === PNG SEQUENCE === */
const TOTAL_FRAMES = 30;
const FRAME_INTERVAL = 60;
const frames = [];
let frameIndex = 0, lastFrameTime = 0;

for(let i=1;i<=TOTAL_FRAMES;i++){
  const img=new Image();
  img.src=`assets/frame_${i}.png`;
  frames.push(img);
}

/* === VARIÃVEIS === */
let stream,isRecording=false,mediaRecorder,recordedChunks=[],raf;
let usingFrontCamera=true,recordingStartTime=0;
let currentDownloadData={};

const ctxPreview=canvasPreview.getContext('2d');
const ctxFinal=canvasFinal.getContext('2d',{alpha:false});

/* === PREVIEW LOOP === */
function previewLoop(t){
  canvasPreview.width=1080;
  canvasPreview.height=1920;
  drawVideo(ctxPreview,1080,1920);
  drawAnimatedFrame(ctxPreview,1080,1920,t);
  raf=requestAnimationFrame(previewLoop);
}

/* === DRAW === */
function drawAnimatedFrame(ctx,w,h,t){
  if(t-lastFrameTime>FRAME_INTERVAL){
    frameIndex=(frameIndex+1)%TOTAL_FRAMES;
    lastFrameTime=t;
  }
  const img=frames[frameIndex];
  if(img.complete) ctx.drawImage(img,0,0,w,h);
}

function drawVideo(ctx,w,h){
  const vw=camera.videoWidth,vh=camera.videoHeight;
  if(!vw||!vh)return;
  const r=Math.max(w/vw,h/vh);
  ctx.drawImage(camera,(w-vw*r)/2,(h-vh*r)/2,vw*r,vh*r);
}

/* === FOTO === */
function takePhoto(){
  canvasFinal.width=1080;
  canvasFinal.height=1920;
  drawVideo(ctxFinal,1080,1920);
  drawAnimatedFrame(ctxFinal,1080,1920,performance.now());
  canvasFinal.toBlob(b=>showResult('image',b),'image/png');
}

/* === VÃDEO === */
function startRecording(){
  isRecording=true;
  recordedChunks=[];
  recordingTimer.style.display='block';
  recordingStartTime=Date.now();

  canvasFinal.width=720;
  canvasFinal.height=1280;

  function recordLoop(t){
    if(!isRecording)return;
    ctxFinal.clearRect(0,0,720,1280);
    drawVideo(ctxFinal,720,1280);
    drawAnimatedFrame(ctxFinal,720,1280,t);
    updateTimer();
    requestAnimationFrame(recordLoop);
  }
  recordLoop();

  const canvasStream = canvasFinal.captureStream(30);

  // ðŸ”´ ADICIONA ÃUDIO AO STREAM FINAL
  stream.getAudioTracks().forEach(track=>{
    canvasStream.addTrack(track);
  });

  mediaRecorder = new MediaRecorder(canvasStream,{mimeType:'video/webm'});
  mediaRecorder.ondataavailable=e=>recordedChunks.push(e.data);
  mediaRecorder.onstop=()=>{
    const blob=new Blob(recordedChunks,{type:'video/webm'});
    showResult('video',blob);
  };
  mediaRecorder.start();
}

function stopRecording(){
  isRecording=false;
  mediaRecorder.stop();
  recordingTimer.style.display='none';
}

/* === RESULTADO === */
function showResult(type,blob){
  cancelAnimationFrame(raf);
  canvasPreview.style.display='none';
  camera.style.display='none';
  cameraUI.style.display='none';
  resultUI.style.display='flex';

  const url=URL.createObjectURL(blob);
  currentDownloadData={url,filename:`${type}_${Date.now()}.${type==='image'?'png':'webm'}`};

  if(type==='video'){
    videoPreview.src=url;
    videoPreview.style.display='block';
    videoPreview.play();
  }
}

/* === AUX === */
function updateTimer(){
  const s=Math.floor((Date.now()-recordingStartTime)/1000);
  recordingTimer.innerText=`00:${String(s).padStart(2,'0')}`;
}

function resetCamera(){
  URL.revokeObjectURL(currentDownloadData.url||'');
  videoPreview.pause();
  videoPreview.src='';
  videoPreview.style.display='none';
  camera.style.display='block';
  canvasPreview.style.display='block';
  cameraUI.style.display='flex';
  resultUI.style.display='none';
  previewLoop(performance.now());
}

function triggerDownload(){
  const a=document.createElement('a');
  a.href=currentDownloadData.url;
  a.download=currentDownloadData.filename;
  a.click();
}

downloadBtn.onclick=triggerDownload;
newPhotoBtn.onclick=resetCamera;
capturePhotoBtn.onclick=takePhoto;
captureVideoBtn.onclick=()=>isRecording?stopRecording():startRecording();
switchBtn.onclick=()=>{usingFrontCamera=!usingFrontCamera;initCamera();};
startBtn.onclick=()=>initCamera();

async function initCamera(){
  stream&&stream.getTracks().forEach(t=>t.stop());
  stream=await navigator.mediaDevices.getUserMedia({
    video:{facingMode:usingFrontCamera?'user':'environment'},
    audio:true
  });
  camera.srcObject=stream;
  camera.onloadedmetadata=()=>{
    camera.play();
    startScreen.style.display='none';
    cameraUI.style.display='flex';
    canvasPreview.style.display='block';
    previewLoop(performance.now());
  };
}
</script>

</body>
</html>
