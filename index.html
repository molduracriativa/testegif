<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>CÃ¢mera com Moldura GIF</title>

<style>
body {
    margin: 0;
    background: #000;
    overflow: hidden;
    font-family: sans-serif;
}

.stage {
    position: relative;
    width: 100vw;
    height: 100dvh;
}

#camera {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
}

#camera.mirrored {
    transform: scaleX(-1);
}

#molduraPreview {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    object-fit: cover;
    z-index: 5;
}

canvas {
    display: none;
}

.controls {
    position: absolute;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
}

button {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 4px solid #fff;
    background: rgba(255,255,255,0.2);
    cursor: pointer;
}
button.recording {
    border-color: red;
    background: rgba(255,0,0,0.5);
}
</style>
</head>

<body>

<div class="stage">
    <video id="camera" autoplay playsinline muted></video>

    <!-- GIF DA MOLDURA -->
    <img id="molduraPreview" src="molduravideo.gif">

    <canvas id="canvasFinal"></canvas>

    <div class="controls">
        <button id="recordBtn"></button>
    </div>
</div>

<script>
let stream;
let usingFrontCamera = true;
let isRecording = false;
let recorder;
let chunks = [];
let rafId;

const video = document.getElementById('camera');
const canvas = document.getElementById('canvasFinal');
const ctx = canvas.getContext('2d', { alpha: false });
const moldura = document.getElementById('molduraPreview');
const recordBtn = document.getElementById('recordBtn');

/* ================= CAMERA ================= */

async function initCamera() {
    stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "user", aspectRatio: 9/16 },
        audio: true
    });
    video.srcObject = stream;
    video.classList.add('mirrored');
}

initCamera();

/* ================= DRAW ================= */

function drawCamera() {
    const vw = video.videoWidth;
    const vh = video.videoHeight;
    if (!vw || !vh) return;

    ctx.save();
    ctx.translate(canvas.width / 2, canvas.height / 2);
    ctx.scale(-1, 1);

    const scale = Math.max(canvas.width / vw, canvas.height / vh);
    const dw = vw * scale;
    const dh = vh * scale;

    ctx.drawImage(video, -dw/2, -dh/2, dw, dh);
    ctx.restore();
}

function drawMoldura() {
    if (!moldura.complete) return;

    const iw = moldura.naturalWidth;
    const ih = moldura.naturalHeight;
    if (!iw || !ih) return;

    const scale = Math.max(canvas.width / iw, canvas.height / ih);
    const dw = iw * scale;
    const dh = ih * scale;

    const dx = (canvas.width - dw) / 2;
    const dy = (canvas.height - dh) / 2;

    ctx.drawImage(moldura, dx, dy, dw, dh);
}

function render() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawCamera();
    drawMoldura();
    rafId = requestAnimationFrame(render);
}

/* ================= RECORD ================= */

recordBtn.onclick = () => {
    if (!isRecording) startRecording();
    else stopRecording();
};

function startRecording() {
    isRecording = true;
    recordBtn.classList.add('recording');

    canvas.width = 720;
    canvas.height = 1280;

    render();

    const canvasStream = canvas.captureStream(30);
    const audioTrack = stream.getAudioTracks()[0];
    if (audioTrack) canvasStream.addTrack(audioTrack);

    recorder = new MediaRecorder(canvasStream, { mimeType: "video/webm" });
    chunks = [];

    recorder.ondataavailable = e => chunks.push(e.data);
    recorder.onstop = saveVideo;

    recorder.start();
}

function stopRecording() {
    isRecording = false;
    recordBtn.classList.remove('recording');
    cancelAnimationFrame(rafId);
    recorder.stop();
}

function saveVideo() {
    const blob = new Blob(chunks, { type: "video/webm" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `video_${Date.now()}.webm`;
    a.click();

    URL.revokeObjectURL(url);
}
</script>

</body>
</html>
