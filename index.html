<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>C√¢mera 9:16 Moldura Animada</title>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#000;overflow:hidden;font-family:Arial}

#startScreen{
    position:fixed;inset:0;
    background:url("capa.jpg") center/cover no-repeat;
    display:flex;justify-content:center;align-items:center;z-index:10
}
#startBtn{padding:18px 36px;border-radius:40px;border:none;font-size:18px}

#camera{
    position:fixed;inset:0;display:none;background:#000
}
video{width:100%;height:100%;object-fit:cover}

#overlay{
    position:absolute;inset:0;pointer-events:none
}
#overlay img{width:100%;height:100%;object-fit:cover}

.controls{
    position:absolute;bottom:20px;width:100%;
    display:flex;justify-content:space-around;z-index:5
}
.controls button{
    width:70px;height:70px;border-radius:50%;border:none;font-size:20px
}

#recordBtn{background:red;position:relative}
#recordBtn.recording{background:#111}
#ring{
    position:absolute;inset:-6px;
    border:4px solid red;border-top-color:transparent;
    border-radius:50%;display:none;animation:spin 1s linear infinite
}
#recordBtn.recording #ring{display:block}
@keyframes spin{to{transform:rotate(360deg)}}

#preview{
    position:fixed;inset:0;background:#000;display:none;
    flex-direction:column;justify-content:center;align-items:center
}
#preview video,#preview img{max-width:100%;max-height:100%}
#downloadBtn{margin-top:20px;padding:12px 26px;font-size:16px}
</style>
</head>

<body>

<div id="startScreen">
    <button id="startBtn">Iniciar</button>
</div>

<div id="camera">
    <video id="video" autoplay muted playsinline></video>
    <div id="overlay"><img id="frameImg"></div>

    <div class="controls">
        <button id="switchBtn">‚Ü∫</button>
        <button id="photoBtn">üì∏</button>
        <button id="recordBtn"><div id="ring"></div></button>
    </div>
</div>

<div id="preview">
    <video id="videoPreview" controls></video>
    <img id="imgPreview">
    <button id="downloadBtn">Salvar</button>
</div>

<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js"></script>
<script>
/* ================= CONFIG ================= */
const TOTAL_FRAMES = 30;
const FRAME_INTERVAL = 60;
const MAX_DURATION = 60;

/* =============== ELEMENTOS =============== */
const video = document.getElementById("video");
const frameImg = document.getElementById("frameImg");
const recordBtn = document.getElementById("recordBtn");
const preview = document.getElementById("preview");
const videoPreview = document.getElementById("videoPreview");
const imgPreview = document.getElementById("imgPreview");
const downloadBtn = document.getElementById("downloadBtn");

/* =============== VARI√ÅVEIS =============== */
let stream, recorder, chunks=[];
let recording=false, timer;
let frameIndex=0, frames=[];
let cameraMode="environment";
let finalURL=null;

/* =============== FRAMES ================== */
for(let i=1;i<=TOTAL_FRAMES;i++){
    const img=new Image();
    img.src=`assets/frame_${i}.png`;
    frames.push(img);
}

setInterval(()=>{
    frameIndex=(frameIndex+1)%TOTAL_FRAMES;
    frameImg.src=frames[frameIndex].src;
},FRAME_INTERVAL);

/* =============== CAMERA ================== */
async function startCamera(){
    if(stream) stream.getTracks().forEach(t=>t.stop());
    stream=await navigator.mediaDevices.getUserMedia({
        video:{facingMode:cameraMode},audio:true
    });
    video.srcObject=stream;
}
startBtn.onclick=async()=>{
    startScreen.style.display="none";
    camera.style.display="block";
    await startCamera();
};
switchBtn.onclick=async()=>{
    cameraMode=cameraMode==="environment"?"user":"environment";
    await startCamera();
};

/* =============== CANVAS ================== */
const canvas=document.createElement("canvas");
canvas.width=1080;canvas.height=1920;
const ctx=canvas.getContext("2d");

function drawVideo(){
    const vw=video.videoWidth,vh=video.videoHeight;
    const r=Math.max(1080/vw,1920/vh);
    const nw=vw*r,nh=vh*r;
    ctx.drawImage(video,(1080-nw)/2,(1920-nh)/2,nw,nh);
}
function drawFrame(){
    const img=frames[frameIndex];
    if(img.complete) ctx.drawImage(img,0,0,1080,1920);
}

/* =============== FOTO ================== */
photoBtn.onclick=()=>{
    ctx.clearRect(0,0,1080,1920);
    drawVideo();drawFrame();
    finalURL=canvas.toDataURL("image/png");
    imgPreview.src=finalURL;
    imgPreview.style.display="block";
    videoPreview.style.display="none";
    preview.style.display="flex";
};

/* =============== V√çDEO ================== */
recordBtn.onclick=()=>{
    if(!recording){
        recording=true;
        recordBtn.classList.add("recording");
        chunks=[];
        const cs=canvas.captureStream(30);
        stream.getAudioTracks().forEach(t=>cs.addTrack(t));
        recorder=new MediaRecorder(cs);
        recorder.ondataavailable=e=>chunks.push(e.data);
        recorder.onstop=finishVideo;
        recorder.start();

        let start=Date.now();
        (function loop(){
            if(!recording) return;
            ctx.clearRect(0,0,1080,1920);
            drawVideo();drawFrame();
            if((Date.now()-start)/1000>=MAX_DURATION){
                recordBtn.click();
                return;
            }
            requestAnimationFrame(loop);
        })();
    }else{
        recording=false;
        recordBtn.classList.remove("recording");
        recorder.stop();
    }
};

/* =============== FINAL VIDEO ================== */
async function finishVideo(){
    const webm=new Blob(chunks,{type:"video/webm"});
    const ffmpeg=new FFmpeg();
    await ffmpeg.load();
    ffmpeg.writeFile("input.webm",await webm.arrayBuffer());
    await ffmpeg.exec(["-i","input.webm","-movflags","faststart","-pix_fmt","yuv420p","out.mp4"]);
    const mp4=await ffmpeg.readFile("out.mp4");
    finalURL=URL.createObjectURL(new Blob([mp4.buffer],{type:"video/mp4"}));
    videoPreview.src=finalURL;
    videoPreview.style.display="block";
    imgPreview.style.display="none";
    preview.style.display="flex";
}

downloadBtn.onclick=()=>{
    const a=document.createElement("a");
    a.href=finalURL;
    a.download=videoPreview.style.display==="block"?"video.mp4":"foto.png";
    a.click();
};
</script>

</body>
</html>
