<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>C√¢mera Profissional MP4</title>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#000;overflow:hidden;font-family:Arial}

/* CAPA */
#startScreen{position:fixed;inset:0;background:url("capa.jpg") center/cover no-repeat;
display:flex;justify-content:center;align-items:center;z-index:10}
#startBtn{padding:16px 32px;border-radius:40px;border:none;font-size:18px}

/* CAMERA */
#cameraContainer{position:fixed;inset:0;display:none}
video{width:100%;height:100%;object-fit:cover}

/* FRAME */
#frame{position:absolute;inset:0;pointer-events:none}
#frame img{width:100%;height:100%;object-fit:cover}

/* ICONES */
.icon{position:absolute;top:20px;left:20px;font-size:26px;color:#fff;z-index:5;display:none}

/* CONTROLES */
.controls{position:absolute;bottom:30px;width:100%;display:flex;justify-content:space-around;z-index:5}
.controls button{width:72px;height:72px;border-radius:50%;border:none;font-size:20px}

/* RECORD */
#recordBtn{background:red;position:relative}
#recordBtn.recording{background:#111}
#progress{position:absolute;inset:-6px;border-radius:50%}

/* PREVIEW */
#preview{position:fixed;inset:0;background:#000;display:none;flex-direction:column;z-index:20}
#preview video,#preview img{width:100%;height:100%;object-fit:cover}
#previewButtons{position:absolute;bottom:20px;width:100%;display:flex;justify-content:space-around}
#previewButtons button{padding:14px 26px;border-radius:30px;border:none;font-size:16px}
#loading{position:absolute;inset:0;display:none;justify-content:center;align-items:center;
color:#fff;font-size:18px;background:#000c;z-index:30}
</style>
</head>

<body>

<div id="startScreen"><button id="startBtn">Iniciar</button></div>

<div id="cameraContainer">
  <video id="video" autoplay playsinline muted></video>
  <div id="frame"><img id="frameImg" src="assets/frame_1.png"></div>
  <div id="videoIcon" class="icon">üé•</div>
  <div id="photoIcon" class="icon">üì∏</div>

  <div class="controls">
    <button id="photoBtn">üì∏</button>
    <button id="recordBtn">‚óè</button>
  </div>
</div>

<div id="preview">
  <video id="previewVideo" controls></video>
  <img id="previewImg">
  <div id="previewButtons">
    <button id="cancelBtn">Refazer</button>
    <button id="saveBtn">Salvar</button>
  </div>
</div>

<div id="loading">Convertendo para MP4‚Ä¶</div>

<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js"></script>

<script>
const video=document.getElementById("video");
const frameImg=document.getElementById("frameImg");
const preview=document.getElementById("preview");
const previewVideo=document.getElementById("previewVideo");
const loading=document.getElementById("loading");

const canvas=document.createElement("canvas");
canvas.width=1080;canvas.height=1920;
const ctx=canvas.getContext("2d");

let stream,mediaRecorder,chunks=[],recording=false;
let rafId,startTime;
const MAX_TIME=60000;

/* FRAMES */
let f=1;
setInterval(()=>{f=f<30?f+1:1;frameImg.src=`assets/frame_${f}.png`},100);

/* CAMERA */
async function startCamera(){
  stream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  video.srcObject=stream;await video.play();
}
startBtn.onclick=async()=>{
  startScreen.style.display="none";
  cameraContainer.style.display="block";
  await startCamera();
}

/* DRAW */
function draw(){
  const vw=video.videoWidth,vh=video.videoHeight;
  if(!vw)return;
  const s=Math.max(1080/vw,1920/vh);
  ctx.clearRect(0,0,1080,1920);
  ctx.drawImage(video,(1080-vw*s)/2,(1920-vh*s)/2,vw*s,vh*s);
  ctx.drawImage(frameImg,0,0,1080,1920);
}

/* FOTO */
photoBtn.onclick=()=>{
  draw();
  previewImg.src=canvas.toDataURL("image/png");
  previewImg.style.display="block";
  previewVideo.style.display="none";
  preview.style.display="flex";
}

/* VIDEO */
recordBtn.onclick=()=>{
  if(!recording){
    recording=true;chunks=[];startTime=Date.now();
    const out=canvas.captureStream(30);
    stream.getAudioTracks().forEach(t=>out.addTrack(t));
    mediaRecorder=new MediaRecorder(out,{mimeType:"video/webm"});
    mediaRecorder.ondataavailable=e=>chunks.push(e.data);
    mediaRecorder.onstop=convertMP4;
    mediaRecorder.start();
    render();
  }else{
    recording=false;
    cancelAnimationFrame(rafId);
    mediaRecorder.stop();
  }
};

function render(){
  draw();
  if(Date.now()-startTime>=MAX_TIME)mediaRecorder.stop();
  if(recording)rafId=requestAnimationFrame(render);
}

/* CONVERS√ÉO MP4 */
async function convertMP4(){
  loading.style.display="flex";
  const {createFFmpeg,fetchFile}=FFmpeg;
  const ffmpeg=createFFmpeg({log:false});
  await ffmpeg.load();

  ffmpeg.FS("writeFile","input.webm",await fetchFile(new Blob(chunks)));
  await ffmpeg.run("-i","input.webm","-movflags","faststart",
                   "-pix_fmt","yuv420p","-vcodec","libx264","output.mp4");
  const mp4=ffmpeg.FS("readFile","output.mp4");
  const url=URL.createObjectURL(new Blob([mp4.buffer],{type:"video/mp4"}));

  previewVideo.src=url;
  previewVideo.style.display="block";
  previewImg.style.display="none";
  preview.style.display="flex";
  loading.style.display="none";
}

/* PREVIEW */
cancelBtn.onclick=()=>preview.style.display="none";
saveBtn.onclick=()=>{
  const a=document.createElement("a");
  a.href=previewVideo.src||previewImg.src;
  a.download=previewVideo.src?"video.mp4":"foto.png";
  a.click();
  preview.style.display="none";
}
</script>

</body>
</html>
