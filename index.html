<!DOCTYPE html>
<html lang="pt-BR">
<head>
ﾂ <meta charset="UTF-8" />
ﾂ <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
ﾂ <title>Crispoparte V8 - Gravaﾃｧﾃ｣o com GIF</title>
ﾂ <style>
ﾂ ﾂ :root {
ﾂ ﾂ ﾂ --accent: #25D366;
ﾂ ﾂ ﾂ --primary: #FF5722;
ﾂ ﾂ ﾂ --record: #ff0000;
ﾂ ﾂ ﾂ --bg-overlay: rgba(0, 0, 0, 0.65);
ﾂ ﾂ }
ﾂ ﾂﾂ
ﾂ ﾂ * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

ﾂ ﾂ body {ﾂ
ﾂ ﾂ ﾂ margin: 0; background: #000; color: #fff; overflow: hidden;ﾂ
ﾂ ﾂ ﾂ width: 100vw; height: 100dvh;ﾂ
ﾂ ﾂ ﾂ font-family: sans-serif;
ﾂ ﾂ }

ﾂ ﾂ .frame { position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #000; }
ﾂ ﾂ .stage { position: relative; width: 100%; height: 100%; overflow: hidden; background: #111; }

ﾂ ﾂ video, #molduraPreview, #canvasPreview, #videoPreview {ﾂ
ﾂ ﾂ ﾂ position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;ﾂ
ﾂ ﾂ }

ﾂ ﾂ video { transform: scaleX(1); transition: transform 0.3s; }
ﾂ ﾂ video.mirrored { transform: scaleX(-1); }

ﾂ ﾂ #canvasPreview { display: none; z-index: 6; background: #000; } 
ﾂ ﾂ #molduraPreview { pointer-events: none; z-index: 5; } 
ﾂ ﾂ #videoPreview { display: none; z-index: 6; background: #000; }

ﾂ ﾂ /* UI Layers */
ﾂ ﾂ .ui-layer {
ﾂ ﾂ ﾂ position: absolute; inset: 0; pointer-events: none; z-index: 20;
ﾂ ﾂ ﾂ display: flex; flex-direction: column; justify-content: space-between; padding: 20px;
ﾂ ﾂ }

ﾂ ﾂ .top-bar { display: flex; justify-content: space-between; align-items: flex-start; pointer-events: auto; }

ﾂ ﾂ .timer-badge {
ﾂ ﾂ ﾂ ﾂ background: red; color: white; padding: 5px 12px; border-radius: 12px;
ﾂ ﾂ ﾂ ﾂ font-weight: bold; font-size: 16px; display: none; animation: pulse 1s infinite;
ﾂ ﾂ }
ﾂ ﾂ @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

ﾂ ﾂ .controls-bottom {
ﾂ ﾂ ﾂ display: flex; flex-direction: column; align-items: center; gap: 15px; pointer-events: auto; padding-bottom: 20px;
ﾂ ﾂ }

ﾂ ﾂ .mode-switch {
ﾂ ﾂ ﾂ ﾂ display: flex; background: rgba(0,0,0,0.5); border-radius: 20px; padding: 4px; backdrop-filter: blur(4px);
ﾂ ﾂ }
ﾂ ﾂ .mode-btn {
ﾂ ﾂ ﾂ ﾂ padding: 8px 20px; border-radius: 16px; border: none; background: transparent; color: #ccc; font-weight: 600; cursor: pointer;
ﾂ ﾂ }
ﾂ ﾂ .mode-btn.active { background: #fff; color: #000; }

ﾂ ﾂ .btn {ﾂ
ﾂ ﾂ ﾂ padding: 10px 16px; font-size: 14px; font-weight: 600;
ﾂ ﾂ ﾂ border: 2px solid rgba(255,255,255,0.3); border-radius: 20px;ﾂ
ﾂ ﾂ ﾂ background: var(--bg-overlay); color: #fff; cursor: pointer; backdrop-filter: blur(4px);
ﾂ ﾂ }
ﾂ ﾂ .btn.active { border-color: var(--accent); background: rgba(37, 211, 102, 0.2); color: var(--accent); }
ﾂ ﾂ .frame-selector { display: flex; gap: 10px; }

ﾂ ﾂ /* Botﾃ｣o de Captura */
ﾂ ﾂ #captureBtn {ﾂ
ﾂ ﾂ ﾂ width: 80px; height: 80px; border-radius: 50%; border: 4px solid #fff;ﾂ
ﾂ ﾂ ﾂ background: rgba(255,255,255,0.2); cursor: pointer; display: flex;ﾂ
ﾂ ﾂ ﾂ align-items: center; justify-content: center; transition: all 0.2s;
ﾂ ﾂ }
ﾂ ﾂ #captureBtn:active { transform: scale(0.95); }
ﾂ ﾂ #captureBtn svg { width: 36px; height: 36px; fill: #fff; }

ﾂ ﾂ /* Estado Gravando */
ﾂ ﾂ #captureBtn.recording { border-color: var(--record); background: rgba(255, 0, 0, 0.5); }
ﾂ ﾂ #captureBtn.recording svg { fill: var(--record); }
ﾂ ﾂ #captureBtn .stop-icon { display: none; width: 30px; height: 30px; background: var(--record); border-radius: 4px; }
ﾂ ﾂ #captureBtn.recording .stop-icon { display: block; }
ﾂ ﾂ #captureBtn.recording .cam-icon { display: none; }

ﾂ ﾂ #startScreen {ﾂ
ﾂ ﾂ ﾂ position: absolute; inset: 0; background: #000; z-index: 50;ﾂ
ﾂ ﾂ ﾂ display: flex; flex-direction: column; align-items: center; justify-content: center;ﾂ
ﾂ ﾂ ﾂ gap: 20px; text-align: center;
ﾂ ﾂ }
ﾂ ﾂ #startBtn { padding: 18px 32px; font-size: 20px; background: var(--primary); color: white; border: none; border-radius: 50px; cursor: pointer; }

ﾂ ﾂ #postCaptureActions { display: none; flex-direction: column; gap: 12px; width: 100%; max-width: 300px; pointer-events: auto; }
ﾂ ﾂﾂ
ﾂ ﾂ .action-btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; text-align: center; text-decoration: none; display: inline-block; }
ﾂ ﾂ .btn-save { background: var(--accent); color: #fff; }
ﾂ ﾂ .btn-new { background: #555; color: #fff; }
ﾂ ﾂ .flash { position: absolute; inset: 0; background: #fff; opacity: 0; pointer-events: none; z-index: 10; transition: opacity 0.1s; }
ﾂ </style>
</head>
<body>

ﾂ <div class="frame">
ﾂ ﾂ <div class="stage" id="stage">
ﾂ ﾂ ﾂ <video id="camera" autoplay playsinline muted></video>
ﾂ ﾂ ﾂ <canvas id="canvasPreview"></canvas>ﾂ
ﾂ ﾂ ﾂ <video id="videoPreview" playsinline controls></video>
ﾂ ﾂ ﾂ <img id="molduraPreview" alt="Moldura" src="" /> 
ﾂ ﾂ ﾂ <div class="flash" id="flash"></div>

ﾂ ﾂ ﾂ <div class="ui-layer" id="cameraUI" style="display: none;">
ﾂ ﾂ ﾂ ﾂ <div class="top-bar">
ﾂ ﾂ ﾂ ﾂ ﾂ <button class="btn" id="switchBtn">売 Trocar</button>
ﾂ ﾂ ﾂ ﾂ ﾂ <div id="recordingTimer" class="timer-badge">00:00</div>
ﾂ ﾂ ﾂ ﾂ </div>

ﾂ ﾂ ﾂ ﾂ <div class="controls-bottom">
ﾂ ﾂ ﾂ ﾂ ﾂ <div class="mode-switch">
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ<button class="mode-btn active" id="modePhoto">FOTO</button>
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ<button class="mode-btn" id="modeVideo">Vﾃ好EO</button>
ﾂ ﾂ ﾂ ﾂ ﾂ </div>

ﾂ ﾂ ﾂ ﾂ ﾂ <div class="frame-selector">
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ <button class="btn active" id="m1Btn">1</button>
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ <button class="btn" id="m2Btn">2</button>
ﾂ ﾂ ﾂ ﾂ ﾂ </div>

ﾂ ﾂ ﾂ ﾂ ﾂ <button id="captureBtn">
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ <svg class="cam-icon" viewBox="0 0 24 24"><path d="M12 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/><path d="M20 5h-3.17L15 3H9L7.17 5H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 14H4V7h16v12z"/></svg>
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ <div class="stop-icon"></div>
ﾂ ﾂ ﾂ ﾂ ﾂ </button>
ﾂ ﾂ ﾂ ﾂ </div>
ﾂ ﾂ ﾂ </div>

ﾂ ﾂ ﾂ <div class="ui-layer" id="resultUI" style="display: none; justify-content: flex-end; align-items: center;">
ﾂ ﾂ ﾂ ﾂ <div id="postCaptureActions">
ﾂ ﾂ ﾂ ﾂ ﾂ <a id="downloadBtn" class="action-btn btn-save">踏 Baixar / Salvar</a>
ﾂ ﾂ ﾂ ﾂ ﾂ <button id="newPhotoBtn" class="action-btn btn-new">売 Novo</button>
ﾂ ﾂ ﾂ ﾂ </div>
ﾂ ﾂ ﾂ </div>
ﾂ ﾂ </div>
ﾂ </div>

ﾂ <div id="startScreen">
ﾂ ﾂ <h2 style="margin-bottom:0">Cﾃ｢mera Crispoparte</h2>
ﾂ ﾂ <p style="color:#aaa; margin-top:5px">Permita cﾃ｢mera e microfone</p>
ﾂ ﾂ <button id="startBtn">INICIAR</button>
ﾂ ﾂ <p id="errorMsg" style="color:red; font-size:12px; margin-top: 10px;"></p>
ﾂ </div>

ﾂ <canvas id="canvasFinal" style="display: none;"></canvas>

ﾂ <script>
ﾂ ﾂ // --- Config ---
ﾂ ﾂ // 庁 NOME DO ARQUIVO ATUALIZADO PARA 'molduragif.gif'
ﾂ ﾂ const MOLDURAS = { 'm1': 'molduragif.gif', 'm2': 'moldura2.png' };
ﾂ ﾂ let currentMolduraUrl = MOLDURAS['m1'];
ﾂ ﾂ let usingFrontCamera = true;
ﾂ ﾂ let stream = null;
ﾂ ﾂ let currentMode = 'photo';ﾂ
ﾂ ﾂ let isRecording = false;
ﾂ ﾂ let mediaRecorder = null;
ﾂ ﾂ let recordedChunks = [];
ﾂ ﾂ let recordingStartTime = 0;
ﾂ ﾂ let animationFrameId = null;
ﾂ ﾂﾂ
ﾂ ﾂ let finalMimeType = null;
ﾂ ﾂ let finalFileExtension = null;
ﾂ ﾂ let currentBlobUrl = null;ﾂ
ﾂ ﾂﾂ
ﾂ ﾂ let currentDownloadData = { blob: null, filename: null };ﾂ

ﾂ ﾂ // --- DOM Elements ---
ﾂ ﾂ const video = document.getElementById('camera');
ﾂ ﾂ const stage = document.getElementById('stage');
ﾂ ﾂ const canvasPreview = document.getElementById('canvasPreview');
ﾂ ﾂ const videoPreview = document.getElementById('videoPreview');
ﾂ ﾂ const molduraPreview = document.getElementById('molduraPreview');
ﾂ ﾂ const canvasFinal = document.getElementById('canvasFinal');
ﾂ ﾂ const ctxFinal = canvasFinal.getContext('2d', { alpha: false });
ﾂ ﾂﾂ
ﾂ ﾂ const startScreen = document.getElementById('startScreen');
ﾂ ﾂ const cameraUI = document.getElementById('cameraUI');
ﾂ ﾂ const resultUI = document.getElementById('resultUI');
ﾂ ﾂ const captureBtn = document.getElementById('captureBtn');
ﾂ ﾂ const recordingTimer = document.getElementById('recordingTimer');
ﾂ ﾂ const errorMsg = document.getElementById('errorMsg');
ﾂ ﾂ const downloadBtn = document.getElementById('downloadBtn');

ﾂ ﾂ // --- Events ---
ﾂ ﾂ setMoldura(document.getElementById('m1Btn'), 'm1');
ﾂ ﾂ document.getElementById('startBtn').addEventListener('click', () => initCamera(true));ﾂ
ﾂ ﾂ document.getElementById('switchBtn').addEventListener('click', switchCamera);
ﾂ ﾂ document.getElementById('newPhotoBtn').addEventListener('click', resetCamera);
ﾂ ﾂ document.getElementById('m1Btn').addEventListener('click', (e) => setMoldura(e.target, 'm1'));
ﾂ ﾂ document.getElementById('m2Btn').addEventListener('click', (e) => setMoldura(e.target, 'm2'));
ﾂ ﾂ document.getElementById('modePhoto').addEventListener('click', () => setMode('photo'));
ﾂ ﾂ document.getElementById('modeVideo').addEventListener('click', () => setMode('video'));
ﾂ ﾂﾂ
ﾂ ﾂ captureBtn.addEventListener('click', () => {
ﾂ ﾂ ﾂ ﾂ if (currentMode === 'photo') takePhoto();
ﾂ ﾂ ﾂ ﾂ else {
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ if (!isRecording) startRecording();
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ else stopRecording();
ﾂ ﾂ ﾂ ﾂ }
ﾂ ﾂ });

ﾂ ﾂ downloadBtn.addEventListener('click', triggerDownload);
ﾂ ﾂﾂ
ﾂ ﾂ // --- Download Programﾃ｡tico ---
ﾂ ﾂ function triggerDownload() {
ﾂ ﾂ ﾂ ﾂ const { blob, filename } = currentDownloadData;
ﾂ ﾂ ﾂ ﾂﾂ
ﾂ ﾂ ﾂ ﾂ if (!blob || !filename) {
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ alert("Erro: Arquivo nﾃ｣o encontrado para download. Tente uma nova gravaﾃｧﾃ｣o.");
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ return;
ﾂ ﾂ ﾂ ﾂ }

ﾂ ﾂ ﾂ ﾂ const url = URL.createObjectURL(blob);
ﾂ ﾂ ﾂ ﾂﾂ
ﾂ ﾂ ﾂ ﾂ const tempLink = document.createElement('a');
ﾂ ﾂ ﾂ ﾂ tempLink.style.display = 'none';
ﾂ ﾂ ﾂ ﾂﾂ
ﾂ ﾂ ﾂ ﾂ tempLink.href = url;
ﾂ ﾂ ﾂ ﾂ tempLink.download = filename;
ﾂ ﾂ ﾂ ﾂﾂ
ﾂ ﾂ ﾂ ﾂ document.body.appendChild(tempLink);
ﾂ ﾂ ﾂ ﾂ tempLink.click();
ﾂ ﾂ ﾂ ﾂ document.body.removeChild(tempLink);
ﾂ ﾂ ﾂ ﾂﾂ
ﾂ ﾂ ﾂ ﾂ URL.revokeObjectURL(url);ﾂ
ﾂ ﾂ }
ﾂ ﾂﾂ
ﾂ ﾂ // --- Funﾃｧﾃｵes Principais de Cﾃ｢mera e Captura ---
ﾂ ﾂﾂ
ﾂ ﾂ function setMode(mode) {
ﾂ ﾂ ﾂ ﾂ currentMode = mode;
ﾂ ﾂ ﾂ ﾂ document.getElementById('modePhoto').className = mode === 'photo' ? 'mode-btn active' : 'mode-btn';
ﾂ ﾂ ﾂ ﾂ document.getElementById('modeVideo').className = mode === 'video' ? 'mode-btn active' : 'mode-btn';
ﾂ ﾂ ﾂ ﾂ captureBtn.style.borderColor = mode === 'video' ? '#ff0000' : '#fff';
ﾂ ﾂ }

ﾂ ﾂ function setMoldura(btn, key) {
ﾂ ﾂ ﾂ document.querySelectorAll('.frame-selector .btn').forEach(b => b.classList.remove('active'));
ﾂ ﾂ ﾂ if(btn) btn.classList.add('active');
ﾂ ﾂ ﾂ currentMolduraUrl = MOLDURAS[key];
ﾂ ﾂ ﾂ molduraPreview.src = currentMolduraUrl;
ﾂ ﾂ }

ﾂ ﾂ async function initCamera(tryAudio = true) {
ﾂ ﾂ ﾂ if (stream) {
ﾂ ﾂ ﾂ ﾂ stream.getTracks().forEach(track => track.stop());
ﾂ ﾂ ﾂ ﾂ stream = null;ﾂ
ﾂ ﾂ ﾂ }
ﾂ ﾂ ﾂ errorMsg.innerText = "Solicitando permissﾃｵes...";

ﾂ ﾂ ﾂ const currentFacingMode = usingFrontCamera ? 'user' : 'environment';
ﾂ ﾂ ﾂﾂ
ﾂ ﾂ ﾂ const constraintsList = [
ﾂ ﾂ ﾂ ﾂ { video: { facingMode: currentFacingMode, width: { ideal: 1280 }, height: { ideal: 720 } } },
ﾂ ﾂ ﾂ ﾂ { video: { facingMode: currentFacingMode, width: { ideal: 640 }, height: { ideal: 480 } } },
ﾂ ﾂ ﾂ ﾂ { video: { facingMode: currentFacingMode } }
ﾂ ﾂ ﾂ ];

ﾂ ﾂ ﾂ for (const videoConstraints of constraintsList) {
ﾂ ﾂ ﾂ ﾂ let constraints = { ...videoConstraints };ﾂ
ﾂ ﾂ ﾂ ﾂ if (tryAudio) { constraints.audio = true; }

ﾂ ﾂ ﾂ ﾂ try {
ﾂ ﾂ ﾂ ﾂ ﾂ stream = await navigator.mediaDevices.getUserMedia(constraints);
ﾂ ﾂ ﾂ ﾂ ﾂ handleStreamSuccess(stream);
ﾂ ﾂ ﾂ ﾂ ﾂ return;ﾂ
ﾂ ﾂ ﾂ ﾂ } catch (err) {
ﾂ ﾂ ﾂ ﾂ ﾂ console.warn(`Tentativa falhou com restriﾃｧﾃｵes:`, constraints, `Erro: ${err.name}`);
ﾂ ﾂ ﾂ ﾂ }
ﾂ ﾂ ﾂ }

ﾂ ﾂ ﾂ if (tryAudio) {
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂerrorMsg.innerText = "Erro no ﾃ｡udio. Tentando iniciar sem microfone...";
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂawait initCamera(false);ﾂ
ﾂ ﾂ ﾂ } else {
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂconst errMsg = `FALHA CRﾃ控ICA! A cﾃ｢mera e o ﾃ｡udio nﾃ｣o puderam ser inicializados.`;
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂerrorMsg.innerText = errMsg;
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂalert(errMsg);ﾂ
ﾂ ﾂ ﾂ }
ﾂ ﾂ }

ﾂ ﾂ function handleStreamSuccess(newStream) {
ﾂ ﾂ ﾂ ﾂ stream = newStream;
ﾂ ﾂ ﾂ ﾂ video.srcObject = stream;
ﾂ ﾂ ﾂ ﾂﾂ
ﾂ ﾂ ﾂ ﾂ if (usingFrontCamera) video.classList.add('mirrored');
ﾂ ﾂ ﾂ ﾂ else video.classList.remove('mirrored');

ﾂ ﾂ ﾂ ﾂ video.onloadedmetadata = () => {
ﾂ ﾂ ﾂ ﾂ ﾂ video.play();
ﾂ ﾂ ﾂ ﾂ ﾂ startScreen.style.display = 'none';
ﾂ ﾂ ﾂ ﾂ ﾂ cameraUI.style.display = 'flex';
ﾂ ﾂ ﾂ ﾂ ﾂ errorMsg.innerText = "";
ﾂ ﾂ ﾂ ﾂ };
ﾂ ﾂ }

ﾂ ﾂ async function switchCamera() {
ﾂ ﾂ ﾂ if (isRecording) stopRecording();ﾂ
ﾂ ﾂ ﾂ usingFrontCamera = !usingFrontCamera;
ﾂ ﾂ ﾂﾂ
ﾂ ﾂ ﾂ await new Promise(resolve => setTimeout(resolve, 1000));ﾂ
ﾂ ﾂ ﾂﾂ
ﾂ ﾂ ﾂ await initCamera(true);
ﾂ ﾂ }
ﾂ ﾂﾂ
ﾂ ﾂ async function takePhoto() {
ﾂ ﾂ ﾂ flashEffect();
ﾂ ﾂ ﾂ canvasFinal.width = 1080; canvasFinal.height = 1920;
ﾂ ﾂ ﾂ drawVideoToCanvas(ctxFinal, 1080, 1920);
ﾂ ﾂ ﾂ await drawImageLayer(ctxFinal, currentMolduraUrl, 1080, 1920); 
ﾂ ﾂ ﾂﾂ
ﾂ ﾂ ﾂ const ctxPrev = canvasPreview.getContext('2d');
ﾂ ﾂ ﾂ canvasPreview.width = stage.clientWidth; canvasPreview.height = stage.clientHeight;
ﾂ ﾂ ﾂ ctxPrev.drawImage(canvasFinal, 0, 0, canvasPreview.width, canvasPreview.height);

ﾂ ﾂ ﾂ canvasFinal.toBlob(blob => {
ﾂ ﾂ ﾂ ﾂ ﾂ showResult('image', blob);
ﾂ ﾂ ﾂ }, 'image/png');
ﾂ ﾂ }

ﾂ ﾂ function startRecording() {
ﾂ ﾂ ﾂ ﾂ isRecording = true;
ﾂ ﾂ ﾂ ﾂ captureBtn.classList.add('recording');
ﾂ ﾂ ﾂ ﾂ recordingTimer.style.display = 'block';
ﾂ ﾂ ﾂ ﾂ recordingStartTime = Date.now();
ﾂ ﾂ ﾂ ﾂ recordedChunks = [];
ﾂ ﾂ ﾂ ﾂ finalMimeType = null;
ﾂ ﾂ ﾂ ﾂ finalFileExtension = null;
ﾂ ﾂ ﾂ ﾂﾂ
ﾂ ﾂ ﾂ ﾂ canvasFinal.width = 720; 
ﾂ ﾂ ﾂ ﾂ canvasFinal.height = 1280;

ﾂ ﾂ ﾂ ﾂ // --- 庁 ATENﾃﾃグ: CONFIGURAﾃﾃグ DE TESTE PARA COBRIR TELA INTEIRA (720x1280) ---
ﾂ ﾂ ﾂ ﾂ const GIF_W = canvasFinal.width; 
ﾂ ﾂ ﾂ ﾂ const GIF_H = canvasFinal.height;
ﾂ ﾂ ﾂ ﾂ const GIF_X = 0;
ﾂ ﾂ ﾂ ﾂ const GIF_Y = 0; 
ﾂ ﾂ ﾂ ﾂ // -----------------------------------------------------------------------------------

ﾂ ﾂ ﾂ ﾂ const loop = () => {
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ if (!isRecording) return;
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ 
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ drawVideoToCanvas(ctxFinal, canvasFinal.width, canvasFinal.height);ﾂ
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂﾂ
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ // DESENHA O FRAME ATUAL DO GIF ANIMADO NO CANVAS
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ if(molduraPreview.complete) {
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ ctxFinal.drawImage(molduraPreview, GIF_X, GIF_Y, GIF_W, GIF_H);
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ }
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂﾂ
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ updateTimer();
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ animationFrameId = requestAnimationFrame(loop);
ﾂ ﾂ ﾂ ﾂ };
ﾂ ﾂ ﾂ ﾂ loop();

ﾂ ﾂ ﾂ ﾂ const canvasStream = canvasFinal.captureStream(30);
ﾂ ﾂ ﾂ ﾂﾂ
ﾂ ﾂ ﾂ ﾂ if (stream && stream.getAudioTracks().length > 0) {
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ canvasStream.addTrack(stream.getAudioTracks()[0]);
ﾂ ﾂ ﾂ ﾂ }

ﾂ ﾂ ﾂ ﾂ const preferredMimeTypes = [
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ 'video/mp4;codecs=avc1.42001E',ﾂ
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ 'video/webm;codecs=vp9',ﾂ ﾂ ﾂ ﾂ
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ 'video/webm;codecs=vp8',ﾂ ﾂ ﾂ ﾂ
ﾂ ﾂ ﾂ ﾂ ];
ﾂ ﾂ ﾂ ﾂﾂ
ﾂ ﾂ ﾂ ﾂ let options = {};
ﾂ ﾂ ﾂ ﾂ let selectedMimeType = null;

ﾂ ﾂ ﾂ ﾂ for (const mimeType of preferredMimeTypes) {
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ if (MediaRecorder.isTypeSupported(mimeType)) {
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ selectedMimeType = mimeType;
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ options = { mimeType: mimeType };
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ break;
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ }
ﾂ ﾂ ﾂ ﾂ }

ﾂ ﾂ ﾂ ﾂ if (!selectedMimeType) {
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ alert("ERRO: O dispositivo nﾃ｣o suporta gravaﾃｧﾃ｣o de vﾃｭdeo. Use o modo FOTO.");
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ isRecording = false;
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ captureBtn.classList.remove('recording');
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ recordingTimer.style.display = 'none';
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ return;ﾂ
ﾂ ﾂ ﾂ ﾂ }
ﾂ ﾂ ﾂ ﾂﾂ
ﾂ ﾂ ﾂ ﾂ finalMimeType = selectedMimeType;
ﾂ ﾂ ﾂ ﾂ finalFileExtension = selectedMimeType.includes('mp4') ? 'mp4' : 'webm';


ﾂ ﾂ ﾂ ﾂ try {
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ mediaRecorder = new MediaRecorder(canvasStream, options);
ﾂ ﾂ ﾂ ﾂ } catch(e) {
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ alert("ERRO CRﾃ控ICO NA GRAVAﾃﾃグ: Nﾃ｣o foi possﾃｭvel iniciar o MediaRecorder. Motivo: " + e.message);
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ isRecording = false;
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ captureBtn.classList.remove('recording');
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ recordingTimer.style.display = 'none';
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ return;
ﾂ ﾂ ﾂ ﾂ }

ﾂ ﾂ ﾂ ﾂ mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
ﾂ ﾂ ﾂ ﾂ mediaRecorder.onstop = finishVideo;
ﾂ ﾂ ﾂ ﾂ mediaRecorder.start(); 
ﾂ ﾂ }

ﾂ ﾂ function stopRecording() {
ﾂ ﾂ ﾂ isRecording = false;
ﾂ ﾂ ﾂ captureBtn.classList.remove('recording');
ﾂ ﾂ ﾂ cancelAnimationFrame(animationFrameId);
ﾂ ﾂ ﾂ if(mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
ﾂ ﾂ ﾂ recordingTimer.style.display = 'none';
ﾂ ﾂ ﾂ recordingTimer.innerText = "00:00";
ﾂ ﾂ }

ﾂ ﾂ function finishVideo() {
ﾂ ﾂ ﾂ const simpleMimeType = finalMimeType ? finalMimeType.split(';')[0] : 'video/webm';
ﾂ ﾂ ﾂ const blob = new Blob(recordedChunks, { type: simpleMimeType });ﾂ
ﾂ ﾂ ﾂﾂ
ﾂ ﾂ ﾂ const videoURL = URL.createObjectURL(blob);
ﾂ ﾂ ﾂ videoPreview.src = videoURL;
ﾂ ﾂ ﾂ showResult('video', blob);
ﾂ ﾂ }

ﾂ ﾂ // --- Helpers ---

ﾂ ﾂ function showResult(type, blob = null) {
ﾂ ﾂ ﾂ video.style.display = 'none'; molduraPreview.style.display = 'none'; cameraUI.style.display = 'none';
ﾂ ﾂ ﾂ resultUI.style.display = 'flex'; document.getElementById('postCaptureActions').style.display = 'flex';
ﾂ ﾂ ﾂﾂ
ﾂ ﾂ ﾂ const timestamp = Date.now();ﾂ

ﾂ ﾂ ﾂ if (currentBlobUrl && currentBlobUrl.startsWith('blob:')) {
ﾂ ﾂ ﾂ ﾂ ﾂ URL.revokeObjectURL(currentBlobUrl);ﾂ
ﾂ ﾂ ﾂ }
ﾂ ﾂ ﾂ currentBlobUrl = null;
ﾂ ﾂ ﾂ currentDownloadData = { blob: null, filename: null };ﾂ

ﾂ ﾂ ﾂ if (type === 'image') {
ﾂ ﾂ ﾂ ﾂ ﾂ canvasPreview.style.display = 'block'; videoPreview.style.display = 'none';
ﾂ ﾂ ﾂ ﾂ ﾂﾂ
ﾂ ﾂ ﾂ ﾂ ﾂ const url = URL.createObjectURL(blob); 
ﾂ ﾂ ﾂ ﾂ ﾂ currentBlobUrl = url;ﾂ
ﾂ ﾂ ﾂ ﾂ ﾂﾂ
ﾂ ﾂ ﾂ ﾂ ﾂ currentDownloadData = { blob, filename: `foto_${timestamp}.png` };
ﾂ ﾂ ﾂ } else {
ﾂ ﾂ ﾂ ﾂ ﾂ canvasPreview.style.display = 'none'; videoPreview.style.display = 'block';
ﾂ ﾂ ﾂ ﾂ ﾂﾂ
ﾂ ﾂ ﾂ ﾂ ﾂ const ext = finalFileExtension || 'webm';ﾂ
ﾂ ﾂ ﾂ ﾂ ﾂﾂ
ﾂ ﾂ ﾂ ﾂ ﾂ currentDownloadData = { blob, filename: `video_${timestamp}.${ext}` };
ﾂ ﾂ ﾂ }
ﾂ ﾂ }

ﾂ ﾂ function resetCamera() {
ﾂ ﾂ ﾂ if (currentBlobUrl && currentBlobUrl.startsWith('blob:')) {
ﾂ ﾂ ﾂ ﾂ ﾂ URL.revokeObjectURL(currentBlobUrl);
ﾂ ﾂ ﾂ }
ﾂ ﾂ ﾂ currentBlobUrl = null;
ﾂ ﾂ ﾂ currentDownloadData = { blob: null, filename: null };

ﾂ ﾂ ﾂ canvasPreview.style.display = 'none'; videoPreview.style.display = 'none'; videoPreview.pause();
ﾂ ﾂ ﾂ video.style.display = 'block'; molduraPreview.style.display = 'block'; 
ﾂ ﾂ ﾂ resultUI.style.display = 'none'; cameraUI.style.display = 'flex';
ﾂ ﾂ ﾂ errorMsg.innerText = "";
ﾂ ﾂ }
ﾂ ﾂﾂ
ﾂ ﾂ // --- Funﾃｧﾃｵes de Gravaﾃｧﾃ｣o e Desenho ---

ﾂ ﾂ function updateTimer() {
ﾂ ﾂ ﾂ ﾂ const diff = Math.floor((Date.now() - recordingStartTime) / 1000);
ﾂ ﾂ ﾂ ﾂ const m = Math.floor(diff / 60).toString().padStart(2,'0');
ﾂ ﾂ ﾂ ﾂ const s = (diff % 60).toString().padStart(2,'0');
ﾂ ﾂ ﾂ ﾂ recordingTimer.innerText = `${m}:${s}`;
ﾂ ﾂ }

ﾂ ﾂ function drawVideoToCanvas(ctx, w, h) {
ﾂ ﾂ ﾂ const vw = video.videoWidth; const vh = video.videoHeight;
ﾂ ﾂ ﾂ if(!vw || !vh) return;
ﾂ ﾂ ﾂ const vidRatio = vw / vh; const canvasRatio = w / h;
ﾂ ﾂ ﾂ let dw, dh, dx, dy;
ﾂ ﾂ ﾂ if (vidRatio > canvasRatio) { dh = h; dw = h * vidRatio; dx = (w - dw) / 2; dy = 0; }ﾂ
ﾂ ﾂ ﾂ else { dw = w; dh = w / vidRatio; dx = 0; dy = (h - dh) / 2; }
ﾂ ﾂ ﾂﾂ
ﾂ ﾂ ﾂ if (usingFrontCamera) {
ﾂ ﾂ ﾂ ﾂ ctx.save();
ﾂ ﾂ ﾂ ﾂ ctx.scale(-1, 1);
ﾂ ﾂ ﾂ ﾂ ctx.drawImage(video, -dx - dw, dy, dw, dh);
ﾂ ﾂ ﾂ ﾂ ctx.restore();
ﾂ ﾂ ﾂ } else {
ﾂ ﾂ ﾂ ﾂ ctx.drawImage(video, dx, dy, dw, dh);
ﾂ ﾂ ﾂ }
ﾂ ﾂ }

ﾂ ﾂ function drawImageLayer(ctx, url, w, h) {
ﾂ ﾂ ﾂ return new Promise(r => {
ﾂ ﾂ ﾂ ﾂ const img = new Image(); img.crossOrigin = "anonymous";
ﾂ ﾂ ﾂ ﾂ img.onload = () => { ctx.drawImage(img, 0, 0, w, h); r(); };
ﾂ ﾂ ﾂ ﾂ img.onerror = r; img.src = url;
ﾂ ﾂ ﾂ });
ﾂ ﾂ }

ﾂ ﾂ function flashEffect() {
ﾂ ﾂ ﾂ ﾂ const f = document.getElementById('flash');
ﾂ ﾂ ﾂ ﾂ f.style.opacity = '1'; setTimeout(() => f.style.opacity = '0', 150);
ﾂ ﾂ }
ﾂ </script>
</body>
</html>
