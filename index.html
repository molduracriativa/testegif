<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Câmera com Moldura GIF Animada</title>

<style>
* { box-sizing: border-box; margin: 0; padding: 0; }

body {
    background: #000;
    color: #fff;
    font-family: Arial, sans-serif;
    overflow: hidden;
}

.stage {
    position: relative;
    width: 100vw;
    height: 100dvh;
    background: #000;
}

#camera {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transform: scaleX(-1);
}

/* GIF carregado como VIDEO (chave da correção) */
#molduraGifVideo {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    pointer-events: none;
    z-index: 5;
}

#videoPreview {
    display: none;
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
    background: #000;
    z-index: 10;
}

.ui {
    position: absolute;
    bottom: 20px;
    width: 100%;
    display: flex;
    justify-content: center;
    gap: 20px;
    z-index: 20;
}

button {
    padding: 14px 22px;
    border-radius: 30px;
    border: none;
    font-size: 16px;
    cursor: pointer;
}

#recordBtn { background: red; color: #fff; }
#stopBtn { background: #555; color: #fff; display: none; }
#downloadBtn { background: #25D366; color: #fff; display: none; }
</style>
</head>

<body>

<div class="stage">
    <video id="camera" autoplay muted playsinline></video>

    <!-- GIF como VIDEO -->
    <video id="molduraGifVideo"
           src="molduravideo.gif"
           autoplay
           loop
           muted
           playsinline>
    </video>

    <video id="videoPreview" controls playsinline></video>

    <div class="ui">
        <button id="recordBtn">● Gravar</button>
        <button id="stopBtn">■ Parar</button>
        <button id="downloadBtn">⬇ Baixar</button>
    </div>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
let stream;
let recorder;
let chunks = [];
let recording = false;
let raf;

const camera = document.getElementById('camera');
const moldura = document.getElementById('molduraGifVideo');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const preview = document.getElementById('videoPreview');

const recordBtn = document.getElementById('recordBtn');
const stopBtn = document.getElementById('stopBtn');
const downloadBtn = document.getElementById('downloadBtn');

/* iniciar câmera */
navigator.mediaDevices.getUserMedia({
    video: { facingMode: "user" },
    audio: true
}).then(s => {
    stream = s;
    camera.srcObject = s;
});

/* loop de render */
function draw() {
    if (!recording) return;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    /* câmera */
    ctx.save();
    ctx.translate(canvas.width / 2, canvas.height / 2);
    ctx.scale(-1, 1);
    ctx.drawImage(
        camera,
        -canvas.width / 2,
        -canvas.height / 2,
        canvas.width,
        canvas.height
    );
    ctx.restore();

    /* GIF animado (frame a frame) */
    if (moldura.readyState >= 2) {
        ctx.drawImage(moldura, 0, 0, canvas.width, canvas.height);
    }

    raf = requestAnimationFrame(draw);
}

/* gravar */
recordBtn.onclick = () => {
    canvas.width = 720;
    canvas.height = 1280;

    chunks = [];
    recording = true;

    moldura.currentTime = 0;
    moldura.play();

    draw();

    const canvasStream = canvas.captureStream(30);
    stream.getAudioTracks().forEach(t => canvasStream.addTrack(t));

    recorder = new MediaRecorder(canvasStream, { mimeType: "video/webm" });

    recorder.ondataavailable = e => e.data.size && chunks.push(e.data);
    recorder.onstop = () => {
        const blob = new Blob(chunks, { type: "video/webm" });
        const url = URL.createObjectURL(blob);
        preview.src = url;
        preview.style.display = "block";

        downloadBtn.onclick = () => {
            const a = document.createElement("a");
            a.href = url;
            a.download = "video_com_moldura.webm";
            a.click();
        };

        downloadBtn.style.display = "block";
    };

    recorder.start();

    recordBtn.style.display = "none";
    stopBtn.style.display = "inline-block";
};

/* parar */
stopBtn.onclick = () => {
    recording = false;
    cancelAnimationFrame(raf);
    recorder.stop();
    moldura.pause();
    stopBtn.style.display = "none";
};
</script>

</body>
</html>
