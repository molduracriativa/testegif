<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>CÃ¢mera 9:16 com Moldura Animada</title>

<style>
* { margin:0; padding:0; box-sizing:border-box; }

body {
    background:#000;
    overflow:hidden;
    font-family:Arial, sans-serif;
}

/* CAPA */
#startScreen {
    position:fixed;
    inset:0;
    background:url("capa.jpg") center/cover no-repeat;
    display:flex;
    justify-content:center;
    align-items:center;
    z-index:10;
}

#startBtn {
    padding:16px 30px;
    border-radius:40px;
    border:none;
    font-size:18px;
    cursor:pointer;
}

/* CAMERA */
#cameraContainer {
    position:fixed;
    inset:0;
    display:none;
    background:#000;
}

video {
    width:100%;
    height:100%;
    object-fit:cover;
}

/* FRAME */
#frame {
    position:absolute;
    inset:0;
    pointer-events:none;
}

#frame img {
    width:100%;
    height:100%;
    object-fit:cover;
}

/* CONTROLES */
.controls {
    position:absolute;
    bottom:20px;
    width:100%;
    display:flex;
    justify-content:space-around;
    z-index:5;
}

.controls button {
    width:70px;
    height:70px;
    border-radius:50%;
    border:none;
    font-size:18px;
    cursor:pointer;
}

#photoBtn { background:#fff; }
#switchBtn { background:#ddd; }

/* BOTÃƒO GRAVAR */
#recordBtn {
    background:red;
    position:relative;
}

#recordBtn.recording {
    background:#111;
}

#recordRing {
    position:absolute;
    inset:-6px;
    border:4px solid red;
    border-top-color:transparent;
    border-radius:50%;
    display:none;
    animation:spin 1s linear infinite;
}

#recordBtn.recording #recordRing {
    display:block;
}

@keyframes spin {
    to { transform:rotate(360deg); }
}
</style>
</head>

<body>

<!-- CAPA -->
<div id="startScreen">
    <button id="startBtn">Iniciar</button>
</div>

<!-- CAMERA -->
<div id="cameraContainer">
    <video id="video" autoplay playsinline muted></video>

    <div id="frame">
        <img id="frameImg" src="assets/frame_1.png">
    </div>

    <div class="controls">
        <button id="switchBtn">â†º</button>
        <button id="photoBtn">ðŸ“¸</button>
        <button id="recordBtn">
            <div id="recordRing"></div>
        </button>
    </div>
</div>

<script>
const video = document.getElementById("video");
const frameImg = document.getElementById("frameImg");
const recordBtn = document.getElementById("recordBtn");

let stream;
let mediaRecorder;
let chunks = [];
let recording = false;
let cameraMode = "environment";

/* FRAMES */
let frame = 1;
setInterval(() => {
    frame++;
    if (frame > 30) frame = 1;
    frameImg.src = `assets/frame_${frame}.png`;
}, 100);

/* CAMERA */
async function startCamera() {
    if (stream) stream.getTracks().forEach(t => t.stop());

    stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: cameraMode },
        audio: true
    });

    video.srcObject = stream;
}

document.getElementById("startBtn").onclick = async () => {
    startScreen.style.display = "none";
    cameraContainer.style.display = "block";
    await startCamera();
};

switchBtn.onclick = async () => {
    cameraMode = cameraMode === "environment" ? "user" : "environment";
    await startCamera();
};

/* FOTO 9:16 */
photoBtn.onclick = () => {
    const canvas = document.createElement("canvas");
    canvas.width = 1080;
    canvas.height = 1920;
    const ctx = canvas.getContext("2d");

    drawCover(ctx);
    ctx.drawImage(frameImg, 0, 0, 1080, 1920);

    download(canvas.toDataURL("image/png"), "foto.png");
};

/* VIDEO 9:16 */
recordBtn.onclick = () => {
    if (!recording) {
        recording = true;
        recordBtn.classList.add("recording");
        chunks = [];

        const canvas = document.createElement("canvas");
        canvas.width = 1080;
        canvas.height = 1920;
        const ctx = canvas.getContext("2d");

        const canvasStream = canvas.captureStream(30);
        stream.getAudioTracks().forEach(t => canvasStream.addTrack(t));

        mediaRecorder = new MediaRecorder(canvasStream);
        mediaRecorder.ondataavailable = e => chunks.push(e.data);
        mediaRecorder.onstop = () => {
            const blob = new Blob(chunks, { type:"video/webm" });
            download(URL.createObjectURL(blob), "video.webm");
        };

        function render() {
            drawCover(ctx);
            ctx.drawImage(frameImg, 0, 0, 1080, 1920);
            if (recording) requestAnimationFrame(render);
        }

        mediaRecorder.start();
        render();
    } else {
        recording = false;
        recordBtn.classList.remove("recording");
        mediaRecorder.stop();
    }
};

/* FUNÃ‡Ã•ES AUX */
function drawCover(ctx) {
    const vw = video.videoWidth;
    const vh = video.videoHeight;
    const ratio = Math.max(1080/vw, 1920/vh);
    const nw = vw * ratio;
    const nh = vh * ratio;
    const x = (1080 - nw) / 2;
    const y = (1920 - nh) / 2;
    ctx.drawImage(video, x, y, nw, nh);
}

function download(url, name) {
    const a = document.createElement("a");
    a.href = url;
    a.download = name;
    a.click();
}
</script>

</body>
</html>
