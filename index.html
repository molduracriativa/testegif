<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Camera com Moldura PNG Animada</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: black;
  overflow: hidden;
}
#stage {
  position: relative;
  width: 100vw;
  height: 100vh;
}
video, canvas {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
}
#controls {
  position: absolute;
  bottom: 20px;
  width: 100%;
  display: flex;
  justify-content: center;
  gap: 20px;
  z-index: 10;
}
button {
  padding: 14px 22px;
  border-radius: 30px;
  border: none;
  font-size: 16px;
}
</style>
</head>

<body>

<div id="stage">
  <video id="camera" autoplay muted playsinline></video>
  <canvas id="canvas"></canvas>

  <div id="controls">
    <button id="recBtn">Gravar</button>
    <button id="stopBtn">Parar</button>
  </div>
</div>

<script>
/* ===== CONFIGURAÇÃO DA ANIMAÇÃO ===== */
const TOTAL_FRAMES = 31;
const FPS = 15;
const FRAME_PATH = 'assets/frames/frame (';

/* ===== ELEMENTOS ===== */
const video = document.getElementById('camera');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

canvas.width = 720;
canvas.height = 1280;

/* ===== CÂMERA ===== */
let stream;
navigator.mediaDevices.getUserMedia({ video: true, audio: true })
.then(s => {
  stream = s;
  video.srcObject = s;
});

/* ===== PRELOAD DOS FRAMES ===== */
const frames = [];
for (let i = 1; i <= TOTAL_FRAMES; i++) {
  const img = new Image();
  img.src = encodeURI(`${FRAME_PATH}${i}).png`);
  frames.push(img);
}

/* ===== LOOP DA ANIMAÇÃO ===== */
let frameIndex = 0;
let lastTime = 0;

function render(time) {
  if (time - lastTime > 1000 / FPS) {
    frameIndex = (frameIndex + 1) % frames.length;
    lastTime = time;
  }

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  /* câmera */
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  /* moldura animada */
  const frame = frames[frameIndex];
  if (frame.complete) {
    ctx.drawImage(frame, 0, 0, canvas.width, canvas.height);
  }

  requestAnimationFrame(render);
}

requestAnimationFrame(render);

/* ===== GRAVAÇÃO ===== */
let recorder;
let chunks = [];

document.getElementById('recBtn').onclick = () => {
  const canvasStream = canvas.captureStream(30);
  stream.getAudioTracks().forEach(t => canvasStream.addTrack(t));

  recorder = new MediaRecorder(canvasStream, { mimeType: 'video/webm' });
  chunks = [];

  recorder.ondataavailable = e => chunks.push(e.data);
  recorder.onstop = () => {
    const blob = new Blob(chunks, { type: 'video/webm' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'video_com_moldura.webm';
    a.click();
  };

  recorder.start();
};

document.getElementById('stopBtn').onclick = () => {
  recorder.stop();
};
</script>

</body>
</html>
