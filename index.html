<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Filtro com Moldura Animada</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    margin: 0;
    background: #000;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
}

#container {
    position: relative;
    width: 360px;
    height: 640px;
}

video, canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
}

#controls {
    position: absolute;
    bottom: 10px;
    width: 100%;
    display: flex;
    justify-content: center;
    gap: 10px;
    z-index: 10;
}

button {
    padding: 8px 12px;
    font-size: 14px;
}
</style>
</head>

<body>

<div id="container">
    <video id="camera" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>

    <div id="controls">
        <button id="btnRecord">Gravar</button>
        <button id="btnStop">Parar</button>
    </div>
</div>

<script>
const video = document.getElementById('camera');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

const FPS = 24;
const TOTAL_FRAMES = 31;

let frames = [];
let currentFrame = 0;
let lastFrameTime = 0;
let animationId;

let mediaRecorder;
let recordedChunks = [];

/* ======================
   CAMERA
====================== */
navigator.mediaDevices.getUserMedia({
    video: { facingMode: 'user' },
    audio: false
}).then(stream => {
    video.srcObject = stream;
});

/* ======================
   CARREGAR PNGs
====================== */
function loadFrames() {
    let loaded = 0;

    for (let i = 1; i <= TOTAL_FRAMES; i++) {
        const img = new Image();
        img.src = `assets/frames/frame (${i}).png`;
        img.onload = () => {
            loaded++;
            if (loaded === TOTAL_FRAMES) {
                console.log('Frames carregados');
                startRender();
            }
        };
        frames.push(img);
    }
}

/* ======================
   RENDER LOOP
====================== */
function startRender() {
    canvas.width = video.videoWidth || 360;
    canvas.height = video.videoHeight || 640;

    function draw(time) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // câmera
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // controle FPS da animação
        if (time - lastFrameTime > 1000 / FPS) {
            currentFrame = (currentFrame + 1) % TOTAL_FRAMES;
            lastFrameTime = time;
        }

        // moldura PNG
        ctx.drawImage(frames[currentFrame], 0, 0, canvas.width, canvas.height);

        animationId = requestAnimationFrame(draw);
    }

    animationId = requestAnimationFrame(draw);
}

/* ======================
   GRAVAÇÃO
====================== */
document.getElementById('btnRecord').onclick = () => {
    recordedChunks = [];

    const stream = canvas.captureStream(FPS);
    mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });

    mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) recordedChunks.push(e.data);
    };

    mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: 'video/webm' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = 'video_com_moldura.webm';
        a.click();
    };

    mediaRecorder.start();
};

document.getElementById('btnStop').onclick = () => {
    mediaRecorder.stop();
};

loadFrames();
</script>

</body>
</html>
